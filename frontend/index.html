<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKV Parse WASM</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .file-input {
            margin: 20px 0;
        }
        .info-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .audio-tracks {
            margin: 20px 0;
        }
        .track-item {
            background: #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .track-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .play-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .play-button:hover {
            background: #0056b3;
        }
        .play-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .audio-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .loading {
            color: #007bff;
            font-style: italic;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MKV Audio Extractor</h1>
        
        <div class="file-input">
            <input type="file" id="fileInput" accept=".mkv">
        </div>

        <div id="loading" class="loading" style="display: none;">
            Processing MKV file...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="info" class="info-section" style="display: none;">
            <h3>File Information</h3>
            <div id="fileInfo"></div>
        </div>

        <div id="audioTracks" class="audio-tracks" style="display: none;">
            <h3>Audio Tracks</h3>
            <div id="tracksList"></div>
        </div>
    </div>

    <script type="module">
        import init, { analyze_mkv } from '../pkg/mkv_parse_wasm.js';

        let currentAudioContext = null;
        let currentSource = null;

        // 初始化 WASM
        init().then(() => {
            console.log('WASM initialized');
        });

        // 文件选择处理
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showLoading();
            hideError();

            try {
                const result = await analyze_mkv(file);
                console.log("MKV analysis result:", result);
                window.lastResult = result; // 保存结果供全局使用
                displayResults(result);
            } catch (error) {
                console.error('Error processing file:', error);
                showError('Error processing MKV file: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function displayResults(result) {
            // 显示文件信息
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <p><strong>Title:</strong> ${result.title || 'Unknown'}</p>
                <p><strong>Duration:</strong> ${result.duration ? formatDuration(result.duration) : 'Unknown'}</p>
                <p><strong>Total Tracks:</strong> ${result.tracks.length}</p>
                <p><strong>Audio Tracks:</strong> ${result.audio_tracks.length}</p>
            `;
            document.getElementById('info').style.display = 'block';

            // 显示音轨
            displayAudioTracks(result.audio_tracks);
        }

        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function displayAudioTracks(audioTracks) {
            const tracksList = document.getElementById('tracksList');
            tracksList.innerHTML = '';

            audioTracks.forEach((track, index) => {
                const trackDiv = document.createElement('div');
                trackDiv.className = 'track-item';
                
                const dataSize = (track.data.length / 1024).toFixed(2);
                
                trackDiv.innerHTML = `
                    <h4>Audio Track ${index + 1}</h4>
                    <div class="audio-info">
                        <p><strong>Track ID:</strong> ${track.track_id}</p>
                        <p><strong>Codec:</strong> ${track.codec}</p>
                        <p><strong>Data Size:</strong> ${dataSize} KB</p>
                    </div>
                    <div class="track-controls">
                        <button class="play-button" onclick="playAudioTrack(${index})" id="play-${index}">
                            Play Track ${index + 1}
                        </button>
                        <button class="play-button" onclick="downloadAudioTrack(${index})" id="download-${index}">
                            Download
                        </button>
                    </div>
                `;
                
                tracksList.appendChild(trackDiv);
            });

            document.getElementById('audioTracks').style.display = 'block';
        }

        // 播放音频轨道
        window.playAudioTrack = async function(trackIndex) {
            const result = window.lastResult;
            if (!result || !result.audio_tracks[trackIndex]) {
                showError('No audio track available');
                return;
            }

            const track = result.audio_tracks[trackIndex];
            const button = document.getElementById(`play-${trackIndex}`);
            button.disabled = true;
            button.textContent = 'Playing...';

            try {
                // 停止当前播放
                if (currentSource) {
                    currentSource.stop();
                    currentSource = null;
                }

                // 创建 AudioContext
                if (!currentAudioContext) {
                    currentAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // 将原始数据转换为 AudioBuffer
                const audioBuffer = await createAudioBufferFromRawData(track.data, track.codec);
                
                // 播放音频
                const source = currentAudioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(currentAudioContext.destination);
                source.start(0);
                
                currentSource = source;

                // 播放完成后恢复按钮
                source.onended = () => {
                    button.disabled = false;
                    button.textContent = `Play Track ${trackIndex + 1}`;
                    currentSource = null;
                };

            } catch (error) {
                console.error('Error playing audio:', error);
                showError('Error playing audio: ' + error.message);
                button.disabled = false;
                button.textContent = `Play Track ${trackIndex + 1}`;
            }
        };

        // 下载音频轨道
        window.downloadAudioTrack = function(trackIndex) {
            const result = window.lastResult;
            if (!result || !result.audio_tracks[trackIndex]) {
                showError('No audio track available');
                return;
            }

            const track = result.audio_tracks[trackIndex];
            const blob = new Blob([track.data], { type: 'audio/raw' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audio_track_${trackIndex + 1}_${track.codec}.raw`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // 从原始数据创建 AudioBuffer
        async function createAudioBufferFromRawData(rawData, codec) {
            // 这里需要根据不同的编解码器进行解码
            // 为了简化，我们假设数据是 PCM 格式
            // 在实际应用中，你可能需要使用 Web Audio API 或其他解码器
            
            const audioContext = currentAudioContext;
            const sampleRate = 44100; // 默认采样率
            const channels = 2; // 默认双声道
            
            // 将 Uint8Array 转换为 Float32Array
            const buffer = new ArrayBuffer(rawData.length);
            const view = new Uint8Array(buffer);
            for (let i = 0; i < rawData.length; i++) {
                view[i] = rawData[i];
            }

            // 创建 AudioBuffer
            const audioBuffer = audioContext.createBuffer(channels, rawData.length / 4, sampleRate);
            
            // 将数据复制到 AudioBuffer
            for (let channel = 0; channel < channels; channel++) {
                const channelData = audioBuffer.getChannelData(channel);
                const dataView = new DataView(buffer);
                
                for (let i = 0; i < channelData.length; i++) {
                    // 假设数据是 16-bit PCM
                    const sample = dataView.getInt16(i * 2, true) / 32768.0;
                    channelData[i] = sample;
                }
            }

            return audioBuffer;
        }

        // 保存结果供全局使用
        window.lastResult = null;
    </script>
</body>
</html>